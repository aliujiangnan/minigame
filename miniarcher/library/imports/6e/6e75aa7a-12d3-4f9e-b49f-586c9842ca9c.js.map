{"version":3,"sources":["../../../../../assets/script/utils/assets/script/utils/HttpApi.js"],"names":["AesCbc","require","HttpApi","method","path","data","timeout","Date","now","token","localStorage","getItem","tokenkey","baseUrl","create","__proto","prototype","send","requestComplete","xhr","XMLHttpRequest","open","setRequestHeader","json","JSON","stringify","BodyToSend","onTimeout","setTimeout","Error","onreadystatechange","readyState","res","Parse","undefined","clearTimeout","bind","responseText","responseError","status","loginObj","parse","setItem","responseAll","StatusCode","postBody","eData","encode","module","exports"],"mappings":"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","file":"HttpApi.js","sourceRoot":"../../../../../assets/script/utils","sourcesContent":["var AesCbc = require(\"AesCbc\");\r\n/*\r\n* HttpApi;\r\n*/\r\nvar HttpApi = (function () {\r\n    function HttpApi(method, path, data, timeout) {\r\n        this.method = method;\r\n        this.path = path;\r\n        this.data = data;\r\n        this.timeout = timeout ? timeout : 5000;\r\n        if(data && method == \"post\"){\r\n            this.data[\"t\"] = Date.now();\r\n        }\r\n        var token = localStorage.getItem(tokenkey);\r\n        this.token = token == null ? \"notoken\" : token;\r\n    }\r\n\r\n    var baseUrl = \"http://127.0.0.1:443\";\r\n    var tokenkey = \"test-token\";\r\n\r\n    HttpApi.create = function (method, path, data, timeout){\r\n        return new HttpApi(method, path, data, timeout);\r\n    }\r\n\r\n    var __proto = HttpApi.prototype;\r\n    __proto.send = function (requestComplete) {\r\n        var xhr = new XMLHttpRequest();\r\n        xhr.timeout = this.timeout;\r\n        var data = null;\r\n        \r\n        if (this.method == \"post\") {\r\n            xhr.open(this.method, baseUrl + this.path, true);\r\n            xhr.setRequestHeader(\"Content-Type\", \"application/json\")\r\n            var json = JSON.stringify(this.data);\r\n            data = this.BodyToSend(json);\r\n        }\r\n        else {\r\n            xhr.open(this.method, baseUrl + this.path + \"?\" + this.data, true);\r\n        }\r\n\r\n        if (this.path != \"/login\") {\r\n            xhr.setRequestHeader(\"Authorization\", \"Bearer \" + this.token);\r\n        }\r\n        if (this.path == \"/login\" || this.path == \"/score/report\" || this.path == \"/exp/add\") {\r\n            xhr.setRequestHeader(\"up-encode\", \"1\");\r\n        }\r\n        else {\r\n            xhr.setRequestHeader(\"up-encode\", \"0\");\r\n        }\r\n        \r\n        var timeout = false;\r\n        var onTimeout = setTimeout(function(){\r\n            timeout = true;\r\n            requestComplete({\r\n                Error:\"request timeout\"\r\n            });\r\n        }, this.timeout)\r\n\r\n        // xhr.ontimeout = function(){\r\n        //     requestComplete({\r\n        //         Error:\"request timeout\"\r\n        //     });\r\n        // };\r\n\r\n        xhr.onreadystatechange = function () {\r\n            if (xhr.readyState == 4) {\r\n                var res = this.Parse(xhr);\r\n                if (!timeout && requestComplete != undefined) {\r\n                    clearTimeout(onTimeout)\r\n                    requestComplete(res);\r\n                }\r\n            }\r\n        }.bind(this);        \r\n        \r\n        xhr.send(data)\r\n    }\r\n\r\n    __proto.Parse = function (xhr) {\r\n        var data = xhr.responseText;\r\n        var responseError = null;\r\n        if (xhr.status == 200) {\r\n            if (this.path == \"/login\") {\r\n                var loginObj = JSON.parse(data);\r\n                localStorage.setItem(tokenkey, loginObj.data.token);\r\n            }\r\n        }\r\n        else if(data == \"\"){\r\n            responseError = \"cannot connect to server\"\r\n        }\r\n        else{\r\n            responseError = JSON.parse(data);\r\n        }\r\n\r\n        var responseAll = {\r\n            Error: responseError,\r\n            data: data,\r\n            StatusCode: xhr.status\r\n        };\r\n\r\n        return responseAll;\r\n    }\r\n\r\n    __proto.BodyToSend = function (data) {\r\n        var postBody;\r\n        if (this.path == \"/login\" || this.path == \"/score/report\" || this.path == \"/exp/add\") {\r\n            var eData = AesCbc.encode(data);\r\n            postBody = \"{\\\"data\\\":\\\"\" + eData + \"\\\"}\";\r\n        }\r\n        else {\r\n            postBody = \"{\\\"data\\\":\" + data + \"}\";\r\n        }\r\n\r\n        return postBody;\r\n    }\r\n\r\n    return HttpApi;\r\n}());\r\n\r\nmodule.exports = HttpApi;\r\n\r\n\r\n\r\n\r\n"]}